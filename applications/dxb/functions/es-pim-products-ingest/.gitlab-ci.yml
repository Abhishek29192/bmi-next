test_es-pim-products-ingest:
  extends: .test_jest
  variables:
    WORKSPACE: "@bmi/es-pim-products-ingest"
    ROOT_DIR: "applications/dxb/functions/es-pim-products-ingest"

build_es-pim-products-ingest:
  extends: .build_function
  variables:
    WORKSPACE: "@bmi/es-pim-products-ingest"
    ROOT_DIR: "applications/dxb/functions/es-pim-products-ingest"

package_es-pim-products-ingest:
  extends: .package_function
  needs:
    - build_es-pim-products-ingest
  dependencies:
    - build_es-pim-products-ingest
  variables:
    FUNCTION_NAME: es-pim-products-ingest
    ROOT_DIR: applications/dxb/functions/es-pim-products-ingest

deploy_es-pim-products-ingest:
  extends: .deploy_function
  needs:
    - package_es-pim-products-ingest
  dependencies:
    - package_es-pim-products-ingest
  variables:
    FUNCTION_NAME: es-pim-products-ingest
    ROOT_DIR: applications/dxb/functions/es-pim-products-ingest

.es-pim-products-ingest_trigger_full_refresh:
  image: !reference [.curl, image]
  stage: post deploy
  rules:
    - when: never
  needs:
    - deploy_es-pim-products-ingest
  cache: []
  script:
    - curl -v ${GCP_PIM_FULL_FETCH_COORDINATOR_ENDPOINT}

es-pim-products-ingest_trigger_full_refresh_dev:
  extends: .es-pim-products-ingest_trigger_full_refresh
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'push' && $CI_COMMIT_BRANCH == 'master'"
  variables:
    GCP_PIM_FULL_FETCH_COORDINATOR_ENDPOINT: ${GCP_PIM_FULL_FETCH_COORDINATOR_ENDPOINT_DEV}

es-pim-products-ingest_trigger_full_refresh_qa:
  extends: .es-pim-products-ingest_trigger_full_refresh
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'push' && $CI_COMMIT_BRANCH == 'master'"
  variables:
    GCP_PIM_FULL_FETCH_COORDINATOR_ENDPOINT: ${GCP_PIM_FULL_FETCH_COORDINATOR_ENDPOINT_QA}

es-pim-products-ingest_trigger_full_refresh_pre_prod_no:
  extends: .es-pim-products-ingest_trigger_full_refresh
  rules:
    - if: "$CI_MERGE_REQUEST_ID"
      when: never
    - if: "$CI_COMMIT_TAG =~ $DXB_RELEASE_TAG_FORMAT_PREPROD"
  variables:
    GCP_PIM_FULL_FETCH_COORDINATOR_ENDPOINT: ${GCP_PIM_FULL_FETCH_COORDINATOR_ENDPOINT_PRE_PROD_NO}

es-pim-products-ingest_trigger_full_refresh_pre_prod_fi:
  extends: .es-pim-products-ingest_trigger_full_refresh
  rules:
    - if: "$CI_MERGE_REQUEST_ID"
      when: never
    - if: "$CI_COMMIT_TAG =~ $DXB_RELEASE_TAG_FORMAT_PREPROD"
  variables:
    GCP_PIM_FULL_FETCH_COORDINATOR_ENDPOINT: ${GCP_PIM_FULL_FETCH_COORDINATOR_ENDPOINT_PRE_PROD_FI}

es-pim-products-ingest_trigger_full_refresh_pre_prod_it:
  extends: .es-pim-products-ingest_trigger_full_refresh
  rules:
    - if: "$CI_MERGE_REQUEST_ID"
      when: never
    - if: "$CI_COMMIT_TAG =~ $DXB_RELEASE_TAG_FORMAT_PREPROD"
  variables:
    GCP_PIM_FULL_FETCH_COORDINATOR_ENDPOINT: ${GCP_PIM_FULL_FETCH_COORDINATOR_ENDPOINT_PRE_PROD_IT}

es-pim-products-ingest_trigger_full_refresh_pre_prod_fr:
  extends: .es-pim-products-ingest_trigger_full_refresh
  rules:
    - if: "$CI_MERGE_REQUEST_ID"
      when: never
    - if: "$CI_COMMIT_TAG =~ $DXB_RELEASE_TAG_FORMAT_PREPROD"
  variables:
    GCP_PIM_FULL_FETCH_COORDINATOR_ENDPOINT: ${GCP_PIM_FULL_FETCH_COORDINATOR_ENDPOINT_PRE_PROD_FR}
