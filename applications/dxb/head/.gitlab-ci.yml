test_head:
  extends: .test_jest_workspace
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'merge_request_event' && ($CI_MERGE_REQUEST_SOURCE_BRANCH_NAME != 'master' || $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME != 'pre-production') || ($CI_PIPELINE_SOURCE == 'push' && $CI_COMMIT_BRANCH == 'master')"
      changes:
        - applications/dxb/head/**/*
        - components/**/*
        - libraries/**/*
        - jest/**/*
        - yarn.lock
  variables:
    WORKSPACE: "@bmi/head"
    ROOT_DIR: "applications/dxb/head"

test_mr_coverage_head:
  extends: .test_jest_mr_coverage_workspace
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'merge_request_event' && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == 'master'"
      changes:
        - applications/dxb/head/**/*
  variables:
    WORKSPACE: "@bmi/head"
    ROOT_DIR: "applications/dxb/head"

build_head_mr:
  extends: .build_yarn_workspace
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'merge_request_event' && ($CI_MERGE_REQUEST_SOURCE_BRANCH_NAME != 'master' || $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME != 'pre-production') || ($CI_PIPELINE_SOURCE == 'push' && $CI_COMMIT_BRANCH == 'master')"
      changes:
        - applications/dxb/head/**/*
        - components/**/*
        - libraries/**/*
        - yarn.lock
  variables:
    WORKSPACE: "@bmi/head"
    ROOT_DIR: "applications/dxb/head"

wait_until_head_deployed_to_gatsby:
  stage: deploy
  image: !reference [.node-full-image, image]
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'merge_request_event' && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == 'master'"
      changes:
        - applications/dxb/head/**/*
        - components/**/*
        - libraries/**/*
  needs: []
  cache: {}
  timeout: 15m
  before_script:
    - apt-get update
    - apt-get install -y jq
  script:
    - |
      commit_time=$(date -u +%s --date=$(git show -s --format=%cd --date=iso-strict $CI_COMMIT_SHA))
      while true; do
        notes=$(curl --header "PRIVATE-TOKEN: ${NETLIFY_GITLAB_TOKEN}" -H "Content-Type: application/json" \
          "$CI_API_V4_URL/projects/19163612/merge_requests/${CI_MERGE_REQUEST_IID}/notes?sort=asc&order_by=created_at&page=1")
        note=$(echo $notes | jq '.[] | select(.body | test("95883ff6-e265-4416-917c-77929cc9970b/sites/527b7de1-e2b0-46fe-91f3-fb65b841a3fd")?)')
        updated_at=$(date -u +%s --date=$(echo $note | jq -r '.updated_at'))
        body=$(echo $note | jq '.body')
        if [[ $(($updated_at - $commit_time)) -gt 0 ]]; then
          if [[ $body == *"Your build was successful!"* ]]; then
            sed -n 's/.*\[See the Deploy preview here.\](\(.*\))\\n\\n##.*/\1/p' <<< $body > deploy_head
            exit 0
          fi
          echo "Latest Gatsby build failed to build."
          exit 1
        fi
        echo "Latest Gatsby build has not been completed yet."
        sleep 30
      done
  artifacts:
    paths:
      - deploy_head

# https://www.zaproxy.org/docs/docker/baseline-scan/
.base_scan:
  stage: post deploy
  rules:
    - when: never
  image: !reference [.owasp-image, image]
  cache: {}
  script:
    - mkdir /zap/wrk
    - cp applications/dxb/head/dast/* /zap/wrk
    - zap-baseline.py -t "${BASE_URL}" -J gl-dast-report.json -r zap_output.html -n ${ZAP_ENVIRONMENT}.context -U ${ZAP_ENVIRONMENT} || failed=true
    - cp /zap/wrk/gl-dast-report.json .
    - cp /zap/wrk/zap_output.html  .
    - "[ $failed ] && exit 1"
  artifacts:
    reports:
      dast: gl-dast-report.json
    paths:
      - zap_output.html
    when: always

# https://www.zaproxy.org/docs/docker/full-scan/
.full_scan:
  stage: post deploy
  rules:
    - when: never
  image: !reference [.owasp-image, image]
  timeout: 3h
  cache: {}
  script:
    - mkdir /zap/wrk
    - cp applications/dxb/head/dast/* /zap/wrk
    - zap-full-scan.py -t "${BASE_URL}" -J gl-dast-report.json -r zap_output.html -n ${ZAP_ENVIRONMENT}.context -U ${ZAP_ENVIRONMENT} || failed=true
    - cp /zap/wrk/gl-dast-report.json .
    - cp /zap/wrk/zap_output.html  .
    - "[ $failed ] && exit 1"
  artifacts:
    reports:
      dast: gl-dast-report.json
    paths:
      - zap_output.html
    when: always

# Triggered when Gatsby deploy is complete
baseline_scan_head_preview:
  extends: .base_scan
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'merge_request_event' && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == 'master'"
      changes:
        - applications/dxb/head/**/*
        - components/**/*
        - libraries/**/*
  needs:
    - wait_until_head_deployed_to_gatsby
  allow_failure: true
  variables:
    ZAP_ENVIRONMENT: "mr"
  before_script:
    - |
      [ ! -f "deploy_head" ] && echo "Nothing deployed to test" && exit 0
      export BASE_URL=$(cat deploy_head)
      [ -z "${BASE_URL}" ] && echo "Nothing deployed to test" && exit 0
      xmlstarlet ed --inplace -P -u '/configuration/context/authentication/form/loginurl' -v "${BASE_URL}" applications/dxb/head/dast/mr.context
      export BASE_URL=${BASE_URL}/no

# Should be set as a scheduled job for cron 0 0 * * 0 (midnight every sunday)
# SAST_DISABLED should be set to true
full_scan_head_qa:
  extends: .full_scan
  rules:
    - if: "$WHICH_SCHEDULE == 'full_scan_head_qa'"
  variables:
    BASE_URL: https://bmi-dxb-head-qa.netlify.app/no
    ZAP_ENVIRONMENT: qa

full_scan_head_pre_prod:
  extends: .full_scan
  rules:
    - if: "$WHICH_SCHEDULE == 'full_scan_head_pre_prod'"
  variables:
    BASE_URL: https://bmi-dxb-head-preproduction.netlify.app/no/
    ZAP_ENVIRONMENT: pre-production

# Should be set as a scheduled job for cron 0 0 * * 0 (midnight every sunday)
# SAST_DISABLED should be set to true
# When happy with how this works, change to use zap-full-scan.py
baseline_scan_head_prod:
  extends: .base_scan
  rules:
    - if: '$WHICH_SCHEDULE == "baseline_scan_head_prod"'
  variables:
    BASE_URL: https://bmi-dxb-head-production.netlify.app/no
    ZAP_ENVIRONMENT: production

# https://github.com/GoogleChrome/lighthouse-ci
.lighthouse_scan:
  stage: post deploy
  variables:
    # Required as QA password has a `$` in it
    NETLIFY_PWD: "$LIGHTHOUSE_PWD"
  rules:
    - when: never
  image: !reference [.cypress-image, image]
  script:
    - |
      params="--collect.settings.pwd=${NETLIFY_PWD}"
      for url in ${LIGHTHOUSE_URLS[@]}; do
        params="$params --collect.url=${url}"
      done
      yarn workspace @bmi/head lighthouse ${params}
  artifacts:
    paths:
      - applications/dxb/head/lighthouseci/reports

# Lighthouse scan on netlify build
lighthouseci_scan_head_preview:
  extends: .lighthouse_scan
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'merge_request_event' && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == 'master'"
      changes:
        - applications/dxb/head/**/*
        - components/**/*
        - libraries/**/*
  needs:
    - job: install_yarn
      optional: true
    - wait_until_head_deployed_to_gatsby
  allow_failure: true
  variables:
    # Required as QA password has a `$` in it
    NETLIFY_PWD: "$NETLIFY_PASSWORD_QA"
  before_script:
    - |
      [ ! -f "deploy_head" ] && echo "Nothing deployed to test" && exit 0
      export base_url=$(cat deploy_head)
      [ -z "${base_url}" ] && echo "Nothing deployed to test" && exit 0
      export LIGHTHOUSE_URLS=(
        "${base_url}/no/"
        "${base_url}/no/contact-us/"
        "${base_url}/no/product-category-page/product-sub-category-page/aerodek-robust-plus/"
      )

# Should be set as a scheduled job for cron 0 2 * * 0 (2am every sunday) for QA
# Additional scheduled jobs for Pre-Prod and Prod at 3am and 4am
# SAST_DISABLED should be set to true
lighthouseci_scan_head:
  extends: .lighthouse_scan
  rules:
    - if: "$WHICH_SCHEDULE == 'lighthouseci_scan_head'"

############################################################################
# Templates used by each market to run content migrations
#
# For example:
# variables:
#   DXB_MARKET_ID: NO
############################################################################
.migrate_content:
  variables:
    DXB_MARKET_ID: "" # Two letter market ID  -i.e. NO
  stage: pre deploy
  rules:
    - if: '($CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "master") || $CI_COMMIT_TAG'
      changes:
        - libraries/migrate/projects/dxb/**/*
  before_script:
    - |
      apt-get update
      apt-get install -y jq

      if [ "$CI_COMMIT_BRANCH" == "master" ]; then
        SOURCE_BRANCH=master
        DXB_MIGRATION_CREDENTIALS=$DXB_MIGRATION_CREDENTIALS_QA
      fi

      if [[ "$CI_COMMIT_TAG" =~ $DXB_RELEASE_TAG_FORMAT_PREPROD ]]; then
        SOURCE_BRANCH=pre-production
        DXB_MIGRATION_CREDENTIALS=$DXB_MIGRATION_CREDENTIALS_PREPROD
      fi

      if [[ "$CI_COMMIT_TAG" =~ $DXB_RELEASE_TAG_FORMAT_PROD ]]; then
        SOURCE_BRANCH=production
        DXB_MIGRATION_CREDENTIALS=$DXB_MIGRATION_CREDENTIALS_PROD
      fi

      export PROJECT_RELATIVE_PATH=projects/dxb
      export MANAGEMENT_ACCESS_TOKEN=$(cat $DXB_MIGRATION_CREDENTIALS | jq -r --arg DXB_MARKET_ID "$DXB_MARKET_ID" '. [$DXB_MARKET_ID] | .MANAGEMENT_ACCESS_TOKEN')
      export SPACE_ID=$(cat $DXB_MIGRATION_CREDENTIALS | jq -r --arg DXB_MARKET_ID "$DXB_MARKET_ID" '. [$DXB_MARKET_ID] | .SPACE_ID')
  script:
    - yarn build-contentful true $SOURCE_BRANCH $CI_COMMIT_TAG

.deploy_gatsby_cloud:
  image: !reference [.node-full-image, image]
  variables:
    DXB_MARKET_ID: "" # Market ID (as specified in GitLab CI Vars) - i.e. NO/FR/GROUP
  stage: deploy
  rules:
    - if: '($CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "master") || $CI_COMMIT_TAG'
      changes:
        - libraries/migrate/projects/dxb/**/*
  cache: {}
  before_script:
    - |
      apt-get update
      apt-get install -y jq

      if [ "$CI_COMMIT_BRANCH" == "master" ]; then
        DXB_BUILD_HOOKS=$DXB_BUILD_HOOKS_QA
      fi

      if [[ "$CI_COMMIT_TAG" =~ $DXB_RELEASE_TAG_FORMAT_PREPROD ]]; then
        DXB_BUILD_HOOKS=$DXB_BUILD_HOOKS_PREPROD
      fi

      if [[ "$CI_COMMIT_TAG" =~ $DXB_RELEASE_TAG_FORMAT_PROD ]]; then
        DXB_BUILD_HOOKS=$DXB_BUILD_HOOKS_PROD
      fi
  script:
    - |
      DXB_MARKET_BUILD_HOOK=$(cat $DXB_BUILD_HOOKS | jq -r --arg DXB_MARKET_ID "$DXB_MARKET_ID" '. [$DXB_MARKET_ID]')
      curl -X POST -d {} $DXB_MARKET_BUILD_HOOK

##############################################################
# Market specific migration and deploy jobs start from here
##############################################################

migrate_content_norway:
  extends: .migrate_content
  needs:
    - job: install_yarn
      optional: true
  variables:
    DXB_MARKET_ID: "NO"
  artifacts:
    name: "migrate_content_norway_log"
    paths:
      - libraries/migrate/projects/dxb/*.log
    expire_in: 1 week

deploy_gatsby_cloud_norway:
  extends: .deploy_gatsby_cloud
  needs:
    - migrate_content_norway
  variables:
    DXB_MARKET_ID: "NO"

migrate_content_italy:
  extends: .migrate_content
  needs:
    - install_yarn
  variables:
    DXB_MARKET_ID: "IT"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as Italy is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

deploy_gatsby_cloud_italy:
  extends: .deploy_gatsby_cloud
  needs:
    - migrate_content_italy
  variables:
    DXB_MARKET_ID: "IT"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as Italy is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

migrate_content_finland:
  extends: .migrate_content
  needs:
    - install_yarn
  variables:
    DXB_MARKET_ID: "FI"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as Finland is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

deploy_gatsby_cloud_finland:
  extends: .deploy_gatsby_cloud
  needs:
    - migrate_content_finland
  variables:
    DXB_MARKET_ID: "FI"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as Finland is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

migrate_content_france:
  extends: .migrate_content
  needs:
    - job: install_yarn
      optional: true
  variables:
    DXB_MARKET_ID: "FR"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as France is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

deploy_gatsby_cloud_france:
  extends: .deploy_gatsby_cloud
  needs:
    - migrate_content_france
  variables:
    DXB_MARKET_ID: "FR"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as France is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

migrate_content_germany:
  extends: .migrate_content
  needs:
    - install_yarn
  variables:
    DXB_MARKET_ID: "DE"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as Germany is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

deploy_gatsby_cloud_germany:
  extends: .deploy_gatsby_cloud
  needs:
    - migrate_content_germany
  variables:
    DXB_MARKET_ID: "DE"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as Germany is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

migrate_content_austria:
  extends: .migrate_content
  needs:
    - install_yarn
  variables:
    DXB_MARKET_ID: "AT"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as Austria is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

deploy_gatsby_cloud_austria:
  extends: .deploy_gatsby_cloud
  needs:
    - migrate_content_austria
  variables:
    DXB_MARKET_ID: "AT"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as Austria is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

migrate_content_netherlands:
  extends: .migrate_content
  needs:
    - install_yarn
  variables:
    DXB_MARKET_ID: "NL"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as Netherlands is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

deploy_gatsby_cloud_netherlands:
  extends: .deploy_gatsby_cloud
  needs:
    - migrate_content_netherlands
  variables:
    DXB_MARKET_ID: "NL"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as Netherlands is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

migrate_content_unitedkingdom:
  extends: .migrate_content
  needs:
    - install_yarn
  variables:
    DXB_MARKET_ID: "UK"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as UK is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

deploy_gatsby_cloud_unitedkingdom:
  extends: .deploy_gatsby_cloud
  needs:
    - migrate_content_unitedkingdom
  variables:
    DXB_MARKET_ID: "UK"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as UK is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

migrate_content_southafrica:
  extends: .migrate_content
  needs:
    - install_yarn
  variables:
    DXB_MARKET_ID: "ZA"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as UK is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

deploy_gatsby_cloud_southafrica:
  extends: .deploy_gatsby_cloud
  needs:
    - migrate_content_southafrica
  variables:
    DXB_MARKET_ID: "ZA"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as UK is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

migrate_content_turkey:
  extends: .migrate_content
  needs:
    - install_yarn
  variables:
    DXB_MARKET_ID: "TR"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as UK is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

deploy_gatsby_cloud_turkey:
  extends: .deploy_gatsby_cloud
  needs:
    - migrate_content_turkey
  variables:
    DXB_MARKET_ID: "TR"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as UK is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

migrate_content_spain:
  extends: .migrate_content
  needs:
    - install_yarn
  variables:
    DXB_MARKET_ID: "ES"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as ES is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

deploy_gatsby_cloud_spain:
  extends: .deploy_gatsby_cloud
  needs:
    - migrate_content_spain
  variables:
    DXB_MARKET_ID: "ES"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as ES is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

migrate_content_portugal:
  extends: .migrate_content
  needs:
    - install_yarn
  variables:
    DXB_MARKET_ID: "PT"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as PT is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

deploy_gatsby_cloud_portugal:
  extends: .deploy_gatsby_cloud
  needs:
    - migrate_content_portugal
  variables:
    DXB_MARKET_ID: "PT"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as PT is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

migrate_content_malaysia:
  extends: .migrate_content
  needs:
    - install_yarn
  variables:
    DXB_MARKET_ID: "MY"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as MY is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

deploy_gatsby_cloud_malaysia:
  extends: .deploy_gatsby_cloud
  needs:
    - migrate_content_malaysia
  variables:
    DXB_MARKET_ID: "MY"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as MY is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

migrate_content_group:
  extends: .migrate_content
  needs:
    - install_yarn
  variables:
    DXB_MARKET_ID: "GROUP"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as Group is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

deploy_gatsby_cloud_group:
  extends: .deploy_gatsby_cloud
  needs:
    - migrate_content_group
  variables:
    DXB_MARKET_ID: "GROUP"
  rules:
    - if: "$CI_COMMIT_TAG" # Only trigger for tags as Group is not on QA
      changes:
        - libraries/migrate/projects/dxb/**/*

migrate_content_sandpit:
  extends: .migrate_content
  needs:
    - install_yarn
  variables:
    DXB_MARKET_ID: "SANDPIT"
  rules:
    # Only trigger for PROD tags
    # Gitlab CI/CD does not currently support pattern matching using a regex in
    # a variable. see https://gitlab.com/gitlab-org/gitlab/-/issues/35438
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/'
      changes:
        - libraries/migrate/projects/dxb/**/*

deploy_gatsby_cloud_sandpit:
  extends: .deploy_gatsby_cloud
  needs:
    - migrate_content_sandpit
  variables:
    DXB_MARKET_ID: "SANDPIT"
  rules:
    # Only trigger for PROD tags
    # Gitlab CI/CD does not currently support pattern matching using a regex in
    # a variable. see https://gitlab.com/gitlab-org/gitlab/-/issues/35438
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/'
      changes:
        - libraries/migrate/projects/dxb/**/*

migrate_content_blueprint:
  extends: .migrate_content
  needs:
    - install_yarn
  variables:
    DXB_MARKET_ID: "BLUEPRINT"
  rules:
    # Only trigger for PROD tags
    # Gitlab CI/CD does not currently support pattern matching using a regex in
    # a variable. see https://gitlab.com/gitlab-org/gitlab/-/issues/35438
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/'
      changes:
        - libraries/migrate/projects/dxb/**/*

deploy_gatsby_cloud_blueprint:
  extends: .deploy_gatsby_cloud
  needs:
    - migrate_content_blueprint
  variables:
    DXB_MARKET_ID: "BLUEPRINT"
  rules:
    # Only trigger for PROD tags
    # Gitlab CI/CD does not currently support pattern matching using a regex in
    # a variable. see https://gitlab.com/gitlab-org/gitlab/-/issues/35438
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/'
      changes:
        - libraries/migrate/projects/dxb/**/*
##############################################################
# Market specific migration and deploy jobs end here
##############################################################
