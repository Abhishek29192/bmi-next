build_intouch_frontend:
  stage: build
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'merge_request_event' || ($CI_PIPELINE_SOURCE == 'push' && $CI_COMMIT_BRANCH == 'master')"
      changes:
        - applications/intouch-frontend/**/*
        - components/**/*
        - libraries/**/*
  needs: [install]
  variables:
    NEXT_PUBLIC_BASE_URL: "https://frontend-rfwslk3zjq-nw.a.run.app"
    AUTH0_NAMESPACE: "https://intouch"
    AUTH0_AUDIENCE: "https://dev-api.intouch.dev"
    AUTH0_SECRET: $INTOUCH_AUTH0_SECRET
    AUTH0_ISSUER_BASE_URL: "https://intouch-dev.eu.auth0.com"
    AUTH0_CLIENT_ID: $INTOUCH_AUTH0_CLIENT_ID
    AUTH0_CLIENT_SECRET: $INTOUCH_AUTH0_CLIENT_SECRET
    GRAPHQL_URL: "https://gateway-rfwslk3zjq-nw.a.run.app/graphql"
  script:
    - yarn workspace @bmi/intouch-frontend build

test_intouch_frontend:
  stage: test
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'merge_request_event' || ($CI_PIPELINE_SOURCE == 'push' && $CI_COMMIT_BRANCH == 'master')"
      changes:
        - applications/intouch-frontend/**/*
        - components/**/*
        - libraries/**/*
        - jest/**/*
  needs: [install]
  before_script:
    - yarn config set cache-folder ~/.yarn
  script:
    - yarn workspace @bmi/intouch-frontend coverage:jest
  coverage: /All\sfiles.*?\s+(\d+.\d+)/

deploy_intouch_frontend_dev:
  stage: deploy
  rules:
    - if: "$CI_COMMIT_BRANCH == 'intouch/dev-environment'"
  script:
    - echo "should deploy InTouch Frontend to dev environment"
