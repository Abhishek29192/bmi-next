<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>InTouch Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      @font-face {
          font-family: 'Effra-Regular';
          font-style: normal;
          font-weight: 400;
          src: url('https://cdn.bmigroup.com/-/media/themes/bmig/global/fonts/effra_w_rg.woff2?rev=9d836de5fcbd491fa6c4604e1e580584') format('woff2'),
              url('https://cdn.bmigroup.com/-/media/themes/bmig/global/fonts/effra_w_rg.woff?rev=f6b7de9460094042a133da70f6697634') format('woff');
      }

      @font-face {
          font-family: 'Effra-Bold';
          font-style: normal;
          font-weight: 700;
          src: url('https://cdn.bmigroup.com/-/media/themes/bmig/global/fonts/effra_w_bd.woff2?rev=7e0aea5910d54cef9feedba05c04793e') format('woff2'),
              url('https://cdn.bmigroup.com/-/media/themes/bmig/global/fonts/effra_w_bd.woff?rev=be807579f97149c8985a8438bc87793a') format('woff');
      }

      @font-face {
          font-family: 'Effra-Heavy';
          font-style: normal;
          font-weight: 900;
          src: url('https://cdn.bmigroup.com/-/media/themes/bmig/global/fonts/effra_w_he.woff2?rev=967101a5f3624dffa2280d70df7bda04') format('woff2'),
              url('https://cdn.bmigroup.com/-/media/themes/bmig/global/fonts/effra_w_he.woff?rev=7af3cdaffa0e4af380a79c9666784652') format('woff');
      }

      [x-cloak] { display: none !important; }

    </style>
    <script type="module">
        import AlpineI18n from 'https://cdn.jsdelivr.net/npm/alpinejs-i18n@2.x.x/dist/module.esm.js'

        document.addEventListener('alpine:init', () => {
            window.Alpine.plugin(AlpineI18n)
        })
    </script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  </head>
  <body>

<div class="login-screen" x-data="{step: 'login'}">

  <form id="signup-form" onsubmit="return false;" method="post">
    <div class="login-box" x-show="step == 'login'">
      <h1 class="underlined-heading" x-text="$t('signup_welcome')">Welcome</h1>
      <label class="mdc-text-field mdc-text-field--outlined">
        <span class="mdc-notched-outline">
          <span class="mdc-notched-outline__leading"></span>
          <span class="mdc-notched-outline__notch">
            <span class="mdc-floating-label" id="login-email-label" x-text="$t('enter_email')">Enter Email</span>
          </span>
          <span class="mdc-notched-outline__trailing"></span>
        </span>
        <input id="login-email" type="email" class="mdc-text-field__input" aria-labelledby="login-email-label">
      </label>

      <div class="password-container">
        <label class="mdc-text-field mdc-text-field--outlined">
          <span class="mdc-notched-outline">
            <span class="mdc-notched-outline__leading"></span>
            <span class="mdc-notched-outline__notch">
              <span class="mdc-floating-label" id="login-password-label" x-text="$t('enter_password')">Enter Password</span>
            </span>
            <span class="mdc-notched-outline__trailing"></span>
          </span>
          <input id="login-password" type="password" class="mdc-text-field__input" aria-labelledby="login-password-label">
        </label>
        <div class="forgot-password-box">
          <button class="link-button" x-text="$t('forgot_password')" @click="step = 'forgot_password'">Forgot password?</a>
        </div>
      </div>

      <div class="button-container">
        <div class="mdc-touch-target-wrapper">
          <button id="btn-login" class="mdc-button mdc-button--unelevated">
            <span class="mdc-button__label" x-text="$t('log_in')">Log in</span>
          </button>
        </div>

        <div class="mdc-touch-target-wrapper">
          <button class="mdc-button mdc-button--touch" @click="step = 'register'">
            <span class="mdc-button__ripple"></span>
            <span class="mdc-button__label mdc-button__underlined" x-text="$t('not_registered')">Not registered?</span>
            <span class="mdc-button__touch"></span>
          </button>
        </div>
      </div>
      <div id="error-message"></div>
    </div>
  </form>

  <form onsubmit="return false;" method="post">
    <div class="login-box" x-show="step == 'register'" x-cloak>
      <h1 class="underlined-heading" x-text="$t('signup_welcome')">Welcome</h1>

      <div class="role-container">
        <p x-text="$t('intouch_role')">Please select your registration type:</p>

        <div class="mdc-form-field">
          <div class="mdc-radio">
            <input class="mdc-radio__native-control" type="radio" id="check-installer" name="intouch_role" value="INSTALLER" checked>
            <div class="mdc-radio__background">
              <div class="mdc-radio__outer-circle"></div>
              <div class="mdc-radio__inner-circle"></div>
            </div>
            <div class="mdc-radio__ripple"></div>
          </div>
          <label for="check-installer" x-text="$t('installer')">Installer</label>
        </div>

        <div class="mdc-form-field">
          <div class="mdc-radio">
            <input class="mdc-radio__native-control" type="radio" id="radio-1" name="intouch_role" value="COMPANY_ADMIN" >
            <div class="mdc-radio__background">
              <div class="mdc-radio__outer-circle"></div>
              <div class="mdc-radio__inner-circle"></div>
            </div>
            <div class="mdc-radio__ripple"></div>
          </div>
          <label for="radio-1" x-text="$t('company')">Company</label>
        </div>
      </div>

      <label class="mdc-text-field mdc-text-field--outlined">
        <span class="mdc-notched-outline">
          <span class="mdc-notched-outline__leading"></span>
          <span class="mdc-notched-outline__notch">
            <span class="mdc-floating-label" id="signup-firstname-label" x-text="$t('first_name')">First Name</span>
          </span>
          <span class="mdc-notched-outline__trailing"></span>
        </span>
        <input id="signup-firstname" type="text" class="mdc-text-field__input" aria-labelledby="signup-firstname-label" id="signup-firstname">
      </label>

      <label class="mdc-text-field mdc-text-field--outlined">
        <span class="mdc-notched-outline">
          <span class="mdc-notched-outline__leading"></span>
          <span class="mdc-notched-outline__notch">
            <span class="mdc-floating-label" id="signup-lastname-label" x-text="$t('last_name')">Last Name</span>
          </span>
          <span class="mdc-notched-outline__trailing"></span>
        </span>
        <input id="signup-lastname" type="text" class="mdc-text-field__input" aria-labelledby="signup-lastname-label" id="signup-lastname">
      </label>

      <label class="mdc-text-field mdc-text-field--outlined">
        <span class="mdc-notched-outline">
          <span class="mdc-notched-outline__leading"></span>
          <span class="mdc-notched-outline__notch">
            <span class="mdc-floating-label" id="signup-email-label" x-text="$t('enter_email')">Enter Email</span>
          </span>
          <span class="mdc-notched-outline__trailing"></span>
        </span>
        <input id="signup-email" type="email" class="mdc-text-field__input" aria-labelledby="signup-email-label" id="signup-email">
      </label>

      <label class="mdc-text-field mdc-text-field--outlined">
        <span class="mdc-notched-outline">
          <span class="mdc-notched-outline__leading"></span>
          <span class="mdc-notched-outline__notch">
            <span class="mdc-floating-label" id="my-label-id" x-text="$t('enter_password')">Enter Password</span>
          </span>
          <span class="mdc-notched-outline__trailing"></span>
        </span>
        <input id="signup-password" type="password" class="mdc-text-field__input" aria-labelledby="my-label-id" id="signup-password">
      </label>

      <div class="button-container">
        <div class="mdc-touch-target-wrapper">
          <button id="btn-signup" class="mdc-button mdc-button--unelevated">
            <span class="mdc-button__label" x-text="$t('sign_up')">Sign Up</span>
          </button>
        </div>

        <div class="mdc-touch-target-wrapper">
          <button class="mdc-button mdc-button--touch" @click="step = 'login'" >
            <span class="mdc-button__ripple"></span>
            <span class="mdc-button__label mdc-button__underlined" x-text="$t('already_registered')">Already registered?</span>
            <span class="mdc-button__touch"></span>
          </button>
        </div>
      </div>
      <div id="error-message"></div>
    </div>
  </form>

  <form onsubmit="return false;" method="post">
    <div class="login-box" x-show="step == 'forgot_password'" x-cloak>
      <h1 class="underlined-heading" x-text="$t('new_password')">Request new password</h1>

      <p x-text="$t('new_password_text')">Please enter your email address and we will send you a link for a password reset</p>

      <label class="mdc-text-field mdc-text-field--outlined">
        <span class="mdc-notched-outline">
          <span class="mdc-notched-outline__leading"></span>
          <span class="mdc-notched-outline__notch">
            <span class="mdc-floating-label" id="reguest-password-label" x-text="$t('enter_email')">Enter Email</span>
          </span>
          <span class="mdc-notched-outline__trailing"></span>
        </span>
        <input type="email" class="mdc-text-field__input" aria-labelledby="reguest-password-label" id="email">
      </label>

      <div class="button-container">
        <div class="mdc-touch-target-wrapper">
          <button class="mdc-button mdc-button--unelevated" id="btn-reset-password">
            <span class="mdc-button__label" x-text="$t('reset_password')">Reset password</span>
          </button>
        </div>

        <div class="mdc-touch-target-wrapper">
          <button class="mdc-button mdc-button--touch" @click="step = 'login'">
            <span class="mdc-button__ripple"></span>
            <span class="mdc-button__label mdc-button__underlined" x-text="$t('back_to_login')">Back to Log In</span>
            <span class="mdc-button__touch"></span>
          </button>
        </div>
      </div>
      <div id="error-message"></div>
    </div>
  </form>
  <div class="captcha-container form-group"></div>
</div>


    <!--[if IE 8]>
      <script src="//cdnjs.cloudflare.com/ajax/libs/ie8/0.2.5/ie8.js"></script>
    <![endif]-->

    <!--[if lte IE 9]>
      <script src="https://cdn.auth0.com/js/polyfills/1.0/base64.min.js"></script>
      <script src="https://cdn.auth0.com/js/polyfills/1.0/es5-shim.min.js"></script>
    <![endif]-->

    <script src="https://cdn.auth0.com/js/auth0/9.16.2/auth0.min.js"></script>
    <script src="https://cdn.auth0.com/js/polyfills/1.0/object-assign.min.js"></script>

      <!-- Required Material Web JavaScript library -->
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <script>
      [].forEach.call(
        document.querySelectorAll(".mdc-text-field"),
        function (el) {
          mdc.textField.MDCTextField.attachTo(el);
        }
      );
    </script>

    <script>
      let locale = 'en';
      let messages = {
        en: {
          intouch_title: "InTouch - Login/Registration",
          signup_welcome: "Welcome",
          intouch_role: "Please select your registration type:",
          installer: "Installer",
          company: "Company",
          first_name: "First Name",
          last_name: "Last Name",
          enter_email: "Email address",
          enter_password: "Password",
          sign_up: "Sign Up",
          already_registered: "Already registered",
          login_welcome: "Welcome",
          log_in: "Log In",
          forgot_password: "Forgot password?",
          not_registered: "Not registered?",
          new_password: "Request new password",
          new_password_text:
            "Please enter your email address and we will send you a link for a password reset",
          reset_password: "Reset Password",
          back_to_login: "Back to Log In"
        },
        it: {
          intouch_title: "In Touch - Login/Registrazione",
          signup_welcome: "Benvenuto",
          intouch_role: "Seleziona il tuo tipo di registrazione:",
          installer: "Installatore",
          company: "Azienda",
          first_name: "Nome",
          last_name: "Cognome",
          enter_email: "Inserisci E-Mail",
          enter_password: "Inserisci password",
          sign_up: "Registrati",
          already_registered: "Già registrato",
          login_welcome: "Benvenuto",
          log_in: "Login",
          forgot_password: "Hai dimenticato la password?",
          not_registered: "Non sei registrato?",
          new_password: "Richiedi nuova password",
          new_password_text:
            "Inserisci il tuo indirizzo email e ti invieremo un link per la reimpostazione della password",
          reset_password: "Reset password",
          back_to_login: "Torna all'accesso"
        }
      };

      // finally, pass them to AlpineI18n:
      document.addEventListener('alpine-i18n:ready', function () {
          window.AlpineI18n.create(locale, messages);
      });

      window.addEventListener("load", function () {

        var hash = location.hash.substr(1);
        // var config = JSON.parse(
        //   decodeURIComponent(escape(window.atob(hash || "@@config@@")))
        // );
        var config = JSON.parse(
          decodeURIComponent(escape(window.atob(hash || "eyJhc3NldHNVcmwiOiIiLCJhdXRoMERvbWFpbiI6ImludG91Y2gtZGV2LmV1LmF1dGgwLmNvbSIsImF1dGgwVGVuYW50IjoiaW50b3VjaC1kZXYiLCJjbGllbnRDb25maWd1cmF0aW9uQmFzZVVybCI6Imh0dHBzOi8vY2RuLmV1LmF1dGgwLmNvbS8iLCJjYWxsYmFja09uTG9jYXRpb25IYXNoIjpmYWxzZSwiY2FsbGJhY2tVUkwiOiJodHRwOi8vbG9jYWxob3N0OjMwMDAvYXBpL2F1dGgvY2FsbGJhY2siLCJjZG4iOiJodHRwczovL2Nkbi5hdXRoMC5jb20vIiwiY2xpZW50SUQiOiJXNGdIMllhZ0RPQmRNcEVVRVNvQzR4WmhzWmJjM1cxUyIsImRpY3QiOnsic2lnbmluIjp7InRpdGxlIjoiTmV4dGpzIn19LCJleHRyYVBhcmFtcyI6eyJwcm90b2NvbCI6Im9hdXRoMiIsInNjb3BlIjoib3BlbmlkIHByb2ZpbGUgZW1haWwiLCJyZXNwb25zZV90eXBlIjoiY29kZSIsImF1ZGllbmNlIjoiaHR0cHM6Ly9kZXYtYXBpLmludG91Y2guZGV2IiwibWFya2V0IjoiZW4iLCJub25jZSI6IkFMWjlGWWhON3NBT3NBMUtVZXU3TkNJa3dEMnFPdmtnbWFCN1BNOUNRS2MiLCJjb2RlX2NoYWxsZW5nZSI6InhIYnpEa3FraW9VU0Y1N3JyTTZJOGl2ZkpqS0gzaWNwZWtlQzNucDVoTjQiLCJjb2RlX2NoYWxsZW5nZV9tZXRob2QiOiJTMjU2IiwiX2NzcmYiOiJKMjZUWHNFUC01WXVCTkpFYUR1WkdVWkFRSVZFcE5VX3QzZnMiLCJfaW50c3RhdGUiOiJkZXByZWNhdGVkIiwic3RhdGUiOiJoS0ZvMlNBM2NsWnJVMlpDT1VOeWREQnlYMmQ2WVRkUFRESm1jekphUm1Vd0xYUjZSYUZ1cFd4dloybHVvM1JwWk5rZ1dHOVpWV0p0YURkbFNUQXdMVTVoV1c4dFpsVlRhRGxGWWtaNU9ETnBXbG1qWTJsazJTQlhOR2RJTWxsaFowUlBRbVJOY0VWVlJWTnZRelI0V21oeldtSmpNMWN4VXcifSwiaW50ZXJuYWxPcHRpb25zIjp7InByb3RvY29sIjoib2F1dGgyIiwic2NvcGUiOiJvcGVuaWQgcHJvZmlsZSBlbWFpbCIsInJlc3BvbnNlX3R5cGUiOiJjb2RlIiwiYXVkaWVuY2UiOiJodHRwczovL2Rldi1hcGkuaW50b3VjaC5kZXYiLCJtYXJrZXQiOiJlbiIsIm5vbmNlIjoiQUxaOUZZaE43c0FPc0ExS1VldTdOQ0lrd0QycU92a2dtYUI3UE05Q1FLYyIsImNvZGVfY2hhbGxlbmdlIjoieEhiekRrcWtpb1VTRjU3cnJNNkk4aXZmSmpLSDNpY3Bla2VDM25wNWhONCIsImNvZGVfY2hhbGxlbmdlX21ldGhvZCI6IlMyNTYiLCJfY3NyZiI6IkoyNlRYc0VQLTVZdUJOSkVhRHVaR1VaQVFJVkVwTlVfdDNmcyIsIl9pbnRzdGF0ZSI6ImRlcHJlY2F0ZWQiLCJzdGF0ZSI6ImhLRm8yU0EzY2xaclUyWkNPVU55ZERCeVgyZDZZVGRQVERKbWN6SmFSbVV3TFhSNlJhRnVwV3h2WjJsdW8zUnBaTmtnV0c5WlZXSnRhRGRsU1RBd0xVNWhXVzh0WmxWVGFEbEZZa1o1T0ROcFdsbWpZMmxrMlNCWE5HZElNbGxoWjBSUFFtUk5jRVZWUlZOdlF6UjRXbWh6V21Kak0xY3hVdyJ9LCJ3aWRnZXRVcmwiOiJodHRwczovL2Nkbi5hdXRoMC5jb20vdzIvYXV0aDAtd2lkZ2V0LTUuMS5taW4uanMiLCJpc1RoaXJkUGFydHlDbGllbnQiOmZhbHNlLCJhdXRob3JpemF0aW9uU2VydmVyIjp7InVybCI6Imh0dHBzOi8vaW50b3VjaC1kZXYuZXUuYXV0aDAuY29tIiwiaXNzdWVyIjoiaHR0cHM6Ly9pbnRvdWNoLWRldi5ldS5hdXRoMC5jb20vIn0sImNvbG9ycyI6eyJwYWdlX2JhY2tncm91bmQiOiIjMDAwMDAwIiwicHJpbWFyeSI6IiNlYTUzMjMifX0=")))
        );

        var leeway = config.internalOptions.leeway;
        if (leeway) {
          var convertedLeeway = parseInt(leeway);

          if (!isNaN(convertedLeeway)) {
            config.internalOptions.leeway = convertedLeeway;
          }
        }

        var params = Object.assign(
          {
            overrides: {
              __tenant: config.auth0Tenant,
              __token_issuer: config.authorizationServer.issuer
            },
            domain: config.auth0Domain,
            clientID: config.clientID,
            redirectUri: config.callbackURL,
            responseType: "code"
          },
          config.internalOptions
        );

        var language = config.extraParams.market;

        var webAuth = new auth0.WebAuth(params);
        var databaseConnection = "Username-Password-Authentication";
        var captcha = webAuth.renderCaptcha(
          document.querySelector(".captcha-container")
        );

        function displayError(err) {
          captcha.reload();
          var errorMessage = document.getElementById("error-message");
          errorMessage.innerHTML = err.description;
          errorMessage.style.display = "block";
        }

        function login(e) {
          e.preventDefault();
          var button = this;
          var username = document.getElementById("login-email").value;
          var password = document.getElementById("login-password").value;
          button.disabled = true;
          webAuth.login(
            {
              realm: databaseConnection,
              username: username,
              password: password,
              captcha: captcha.getValue()
            },
            function (err) {
              if (err) displayError(err);
              button.disabled = false;
            }
          );
        }

        function signup() {
          // Get the form
          const form = document.querySelectorAll("#signup-form")[0];
          const radios = form.elements["intouch_role"];

          var button = this;
          var email = document.getElementById("signup-email").value;
          var password = document.getElementById("signup-password").value;
          var first_name = document.getElementById("signup-firstname").value;
          var last_name = document.getElementById("signup-lastname").value;

          button.disabled = true;
          webAuth.redirect.signupAndLogin(
            {
              connection: databaseConnection,
              email: email,
              password: password,
              captcha: captcha.getValue(),
              user_metadata: {
                intouch_role: radios.value,
                first_name,
                last_name,
                market: config.extraParams.market
              }
            },
            function (err) {
              if (err) displayError(err);
              button.disabled = false;
            }
          );
        }

        function resetPassword(e) {
          e.preventDefault();
          var email = document.getElementById("email").value;
          if (!email) {
            alert("Please enter your email.");
            return;
          }
          webAuth.changePassword(
            {
              connection: databaseConnection,
              email: email
            },
            function (err, resp) {
              if (err) {
                console.log(err.message);
                alert(err.message);
              } else {
                console.log(resp);
                alert(resp);
              }
            }
          );
        }


        document.getElementById("btn-login").addEventListener("click", login);
        document.getElementById("btn-signup").addEventListener("click", signup);
        document
          .getElementById("btn-reset-password")
          .addEventListener("click", resetPassword);


      });
    </script>
  </body>
</html>
