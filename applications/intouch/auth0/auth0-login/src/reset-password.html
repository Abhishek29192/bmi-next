<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>InTouch Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      @font-face {
        font-family: "Effra-Regular";
        font-style: normal;
        font-weight: 400;
        src: url("https://cdn.bmigroup.com/-/media/themes/bmig/global/fonts/effra_w_rg.woff2?rev=9d836de5fcbd491fa6c4604e1e580584")
            format("woff2"),
          url("https://cdn.bmigroup.com/-/media/themes/bmig/global/fonts/effra_w_rg.woff?rev=f6b7de9460094042a133da70f6697634")
            format("woff");
      }

      @font-face {
        font-family: "Effra-Bold";
        font-style: normal;
        font-weight: 700;
        src: url("https://cdn.bmigroup.com/-/media/themes/bmig/global/fonts/effra_w_bd.woff2?rev=7e0aea5910d54cef9feedba05c04793e")
            format("woff2"),
          url("https://cdn.bmigroup.com/-/media/themes/bmig/global/fonts/effra_w_bd.woff?rev=be807579f97149c8985a8438bc87793a")
            format("woff");
      }

      @font-face {
        font-family: "Effra-Heavy";
        font-style: normal;
        font-weight: 900;
        src: url("https://cdn.bmigroup.com/-/media/themes/bmig/global/fonts/effra_w_he.woff2?rev=967101a5f3624dffa2280d70df7bda04")
            format("woff2"),
          url("https://cdn.bmigroup.com/-/media/themes/bmig/global/fonts/effra_w_he.woff?rev=7af3cdaffa0e4af380a79c9666784652")
            format("woff");
      }

      [x-cloak] {
        display: none !important;
      }
    </style>
    <script type="module">
      import AlpineI18n from "https://cdn.jsdelivr.net/npm/alpinejs-i18n@2.x.x/dist/module.esm.js";

      document.addEventListener("alpine:init", () => {
        window.Alpine.plugin(AlpineI18n);
      });
    </script>
    <script
      defer
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
  </head>
  <body>
    <div class="login-screen" x-data>
      <form id="change-password-form" action="/lo/reset" method="post">
        <input type="hidden" name="_csrf" value="{{csrf_token}}" />
        <input type="hidden" name="ticket" value="{{ticket}}" />
        <input type="hidden" name="email" value="{{email}}" />

        <div class="login-box">
          <h1 class="underlined-heading" x-text="$t('reset_welcome')">
            Set my password
          </h1>
          <label class="mdc-text-field mdc-text-field--outlined">
            <span class="mdc-notched-outline">
              <span class="mdc-notched-outline__leading"></span>
              <span class="mdc-notched-outline__notch">
                <span
                  class="mdc-floating-label"
                  id="reset-password-label"
                  x-text="$t('enter_password')"
                  >Password</span
                >
              </span>
              <span class="mdc-notched-outline__trailing"></span>
            </span>
            <input
              id="reset-password"
              name="newPassword"
              type="password"
              class="mdc-text-field__input"
              aria-labelledby="reset-password-label"
            />
          </label>

          <label class="mdc-text-field mdc-text-field--outlined">
            <span class="mdc-notched-outline">
              <span class="mdc-notched-outline__leading"></span>
              <span class="mdc-notched-outline__notch">
                <span
                  class="mdc-floating-label"
                  id="confirm-reset-password-label"
                  x-text="$t('confirm_password')"
                  >Confirm password</span
                >
              </span>
              <span class="mdc-notched-outline__trailing"></span>
            </span>
            <input
              id="confirm-reset-password"
              name="confirmNewPassword"
              type="password"
              class="mdc-text-field__input"
              aria-labelledby="confirm-reset-password-label"
            />
          </label>

          <div class="mdc-form-field terms-check">
            <div class="mdc-checkbox">
              <input
                type="checkbox"
                terms-and-conditions
                class="mdc-checkbox__native-control"
                id="terms-and-conditions"
              />
              <div class="mdc-checkbox__background">
                <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                  <path
                    class="mdc-checkbox__checkmark-path"
                    fill="none"
                    d="M1.73,12.91 8.1,19.28 22.79,4.59"
                  />
                </svg>
                <div class="mdc-checkbox__mixedmark"></div>
              </div>
              <div class="mdc-checkbox__ripple"></div>
            </div>
            <label for="terms-and-conditions">
              <span x-text="$t('i_agree_to')">I agree to BMI's</span>
              <a
                id="terms-link"
                href="#"
                target="_blank"
                x-text="$t('terms_and_conditions')"
                >Terms & Conditions</a
              >
              <span x-text="$t('and')">and</span>
              <a
                id="privacy-link"
                href="#"
                target="_blank"
                x-text="$t('privacy_policy')"
                >Privacy Policy</a
              >
            </label>
          </div>

          <div class="button-container">
            <div class="mdc-touch-target-wrapper">
              <button
                type="submit"
                id="btn-login"
                class="mdc-button mdc-button--unelevated"
              >
                <span class="mdc-button__label" x-text="$t('reset_password')"
                  >Reset password</span
                >
              </button>
            </div>

            <div class="mdc-touch-target-wrapper">
              <a
                id="back-to-login"
                href="#"
                class="mdc-button mdc-button--touch"
              >
                <span class="mdc-button__ripple"></span>
                <span
                  class="mdc-button__label mdc-button__underlined"
                  x-text="$t('back_to_login')"
                  >Back to login</span
                >
                <span class="mdc-button__touch"></span>
              </a>
            </div>

            <div class="mdc-touch-target-wrapper">
              <div
                id="reset-password-error-message"
                class="error-message"
              ></div>
            </div>
            <div class="mdc-touch-target-wrapper">
              <div
                id="reset-password-success-message"
                class="success-message"
              ></div>
            </div>
          </div>
        </div>
      </form>

      <div class="captcha-container form-group"></div>
    </div>

    <script src="//code.jquery.com/jquery-3.2.1.min.js"></script>

    <!-- Required Material Web JavaScript library -->
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <script>
      [].forEach.call(
        document.querySelectorAll(".mdc-text-field"),
        function (el) {
          mdc.textField.MDCTextField.attachTo(el);
        }
      );
      const MDCTooltip = mdc.tooltip.MDCTooltip;
      const tooltips = [].map.call(
        document.querySelectorAll(".mdc-tooltip"),
        function (el) {
          return new MDCTooltip(el);
        }
      );
    </script>

    <script>
      const messages = {
        en: {
          reset_welcome: "Set my password",
          enter_password: "Password",
          confirm_password: "Confirm password",
          reset_password: "Reset Password",
          back_to_login: "Back to Login",
          reset_password_success: "Check your inbox",
          email_missing: "Please insert your email",
          generic_error:
            "Please check your credential, if the problem persists contact use",
          name_surname_missing: "First and last name missing",
          email_password_missing: "Email and password missing",
          i_agree_to: "I agree to BMI's",
          terms_and_conditions: "Terms & Conditions",
          and: "and",
          privacy_policy: "Privacy Policy",
          success: "You can now access with your new password.",
          error: "Something went wrong, please try again.",
          terms_missing: "Please accept terms & condition",
          password_mismatch: "The 2 passwords are not the same",
          password_missing: "Please fill both the fields"
        },
        no: {
          reset_welcome: "Tilbakestille passord",
          enter_password: "Password",
          confirm_password: "Bekreft passord",
          reset_password: "Tilbakestille passord",
          back_to_login: "Tilbake til innlogging",
          reset_password_success: "Sjekk innboksen din",
          email_missing: "Sett inn e -posten din",
          generic_error:
            "Kontroller legitimasjonen din, kontakt oss hvis problemet vedvarer",
          name_surname_missing: "For og etternavn mangler",
          email_password_missing: "E-post og passord mangler",
          i_agree_to: "Jeg er enig i BMI",
          terms_and_conditions: "Betingelser og vilkår",
          and: "og",
          privacy_policy: "Personvernerklæring",
          success: "Du får nå tilgang med ditt nye passord.",
          error: "Noe gikk galt. Prøv igjen.",
          terms_missing: "Godta vilkår og betingelser",
          password_mismatch: "De to passordene er ikke like",
          password_missing: "Fyll ut begge feltene"
        }
      };

      const market = document.location.hash.replace("#", "") || "en";

      const setupImage = () => {
        // Map market / projects status
        var marketsProjectMap = {
          no: true, // project active
          it: true,
          en: false // project not active
        };

        // Map projects status / image
        var marketImages = {
          projectActive: "@@roof_imf@@",
          projectNotActive: "@@non_roof_img@@"
        };

        if (document.getElementsByClassName("login-screen").length) {
          const image = marketsProjectMap[market]
            ? marketImages.projectActive
            : marketImages.projectNotActive;

          console.log("image", image);

          document.getElementsByClassName(
            "login-screen"
          )[0].style.backgroundImage = `linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url("${image}")`;
        }
      };

      // finally, pass them to AlpineI18n:
      document.addEventListener("alpine-i18n:ready", function () {
        window.AlpineI18n.create(market, messages);
      });

      window.addEventListener("load", function () {
        Alpine.start();

        setupImage();

        document.getElementById("terms-link").href =
          "@@base_url@@/terms".replace("{market}", market);
        document.getElementById("privacy-link").href =
          "@@base_url@@/privacy".replace("{market}", market);
        document.getElementById("back-to-login").href =
          "@@base_url@@/api/auth/login".replace("{market}", market);

        const completedView = $("#reset-password-success-message");
        const errorView = $("#reset-password-error-message");
        const form = $("#change-password-form");
        form.submit(function (e) {
          e.preventDefault();

          errorView.hide();
          completedView.hide();

          const password = $("#reset-password").val();
          const newPassword = $("#confirm-reset-password").val();

          if (!password || !newPassword) {
            errorView.show();
            errorView.html(AlpineI18n.t("password_missing"));
            return;
          }

          if (password !== newPassword) {
            errorView.show();
            errorView.html(AlpineI18n.t("password_mismatch"));
            return;
          }

          if (!document.querySelectorAll("#terms-and-conditions")[0].checked) {
            errorView.show();
            errorView.html(AlpineI18n.t("terms_missing"));
            return;
          }

          $.ajax({
            type: form.attr("method"),
            url: form.attr("action"),
            data: form.serialize(),
            success: handleSuccess,
            error: handleError
          });
        });

        const handleSuccess = function (res) {
          // Check if the Email Template contains a redirectTo url.  If so redirect there.
          if (res && typeof res.result_url === "string") {
            return window.location.replace(res.result_url);
          } else {
            // Show and on-page view
            errorView.hide();
            completedView.show();
            completedView.html(AlpineI18n.t("success"));
          }
        };

        const handleError = function (res) {
          var getErrorFunc = !!res ? getResponseError : getNetworkError;
          var error = getErrorFunc(res);

          completedView.hide();
          errorView.show();
          errorView.html(AlpineI18n.t("error"));
        };

        const getResponseError = function (res) {
          var body,
            text = res;

          if (!body || typeof body !== "object") {
            body = {};
          }

          passwordErrors = {
            PasswordStrengthError: "weakPasswordError",
            PasswordHistoryError: "passwordHistoryError",
            PasswordDictionaryError: "passwordDictError",
            PasswordNoUserInfoError: "passwordNoUserInfoError"
          };

          var error = passwordErrors[body.name] || "serverError";

          return error;
        };

        const getNetworkError = function (res) {
          var didTimeout = !!err.timeout;
          var error = didTimeout ? "timedoutError" : "networkError";

          return error;
        };
      });
    </script>

    <div id="tooltip-id" class="mdc-tooltip" role="tooltip" aria-hidden="true">
      <div class="mdc-tooltip__surface mdc-tooltip__surface-animation">
        lorem ipsum dolor
      </div>
    </div>
  </body>
</html>
