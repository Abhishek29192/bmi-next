plan_terraform:
  # do not start this job before all builds & deployments (if any) have been completed
  # we need to plan & execute Terraform after the Docker images have been
  # built and tagged with "latest", which is the Docker tag that Terraform uses
  # to know which version to deploy with the changes (e.g. to variables)
  stage: terraform_plan
  cache: {}
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'push' && $CI_COMMIT_BRANCH == 'master'"
      changes:
        - applications/intouch/terraform/*
        - applications/intouch/terraform/**/*
  image:
    name: hashicorp/terraform:light
    entrypoint:
      - /usr/bin/env
      - "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  before_script:
    - echo $GCP_INTOUCH_REPLATFORM_SERVICE_KEY > applications/intouch/terraform/gcloud-service-key.json
    - export GOOGLE_APPLICATION_CREDENTIALS="applications/intouch/terraform/gcloud-service-key.json"
    - terraform -chdir=applications/intouch/terraform init -reconfigure
  script:
    - cd applications/intouch/terraform
    - terraform plan -out "planfile.tfplan"
  artifacts:
    paths:
      - applications/intouch/terraform/*.tfplan
      - terraform
    expire_in: 1 week

apply_terraform:
  needs:
    - plan_terraform
  stage: terraform_execute
  cache: {}
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'push' && $CI_COMMIT_BRANCH == 'master'"
      changes:
        - applications/intouch/terraform/*
        - applications/intouch/terraform/**/*
      when: manual
  image:
    name: hashicorp/terraform:light
    entrypoint:
      - /usr/bin/env
      - "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  before_script:
    - echo $GCP_INTOUCH_REPLATFORM_SERVICE_KEY > applications/intouch/terraform/gcloud-service-key.json
    - export GOOGLE_APPLICATION_CREDENTIALS="applications/intouch/terraform/gcloud-service-key.json"
    - terraform -chdir=applications/intouch/terraform init -reconfigure
  script:
    - cd applications/intouch/terraform
    - terraform apply -auto-approve "planfile.tfplan"
