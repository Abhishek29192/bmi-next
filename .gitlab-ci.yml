image: node:12

include:
  - template: Security/SAST.gitlab-ci.yml
  - local: applications/frc-website/.gitlab-ci.yml
  - local: applications/head/.gitlab-ci.yml
  - local: applications/intouch-frontend/.gitlab-ci.yml
  - local: applications/intouch-api/.gitlab-ci.yml

.sast-analyzer:
  allow_failure: false

cache:
  key:
    files:
      - yarn.lock
  policy: pull
  untracked: true
  paths:
    - "**/node_modules"
    - "~/.yarn"

stages:
  - install
  - audit
  - build
  - test
  - release
  - deploy
  - dynamic_security
  - lighthouse_scan

install:
  stage: install
  except:
    refs:
      - schedules
  before_script:
    - yarn config set cache-folder ~/.yarn
  script:
    - yarn install --frozen-lockfile
  cache:
    key:
      files:
        - yarn.lock
    untracked: true
    paths:
      - "**/node_modules"
      - "~/.yarn"
    policy: pull-push

#  https://github.com/pivotal/LicenseFinder
# Remove report arg when we want this job to fail
# Remove installing node 12 when https://github.com/pivotal/LicenseFinder/issues/812 is resolved
license_finder:
  stage: audit
  except:
    refs:
      - schedules
  needs: [install]
  image: licensefinder/license_finder:latest
  before_script:
    - source ~/.bash_profile
    - yarn config set cache-folder ~/.yarn
    - curl -sL https://deb.nodesource.com/setup_12.x | bash - && apt-get -y install nodejs
  script:
    - license_finder report --format html > license_finder_output.html
  artifacts:
    paths:
      - license_finder_output.html

eslint:
  stage: test
  except:
    refs:
      - schedules
  needs: [install]
  script:
    - yarn eslint "**/*.{js,ts,tsx}"

coverage_jest:
  stage: test
  except:
    refs:
      - schedules
  needs: [install]
  before_script:
    - yarn config set cache-folder ~/.yarn
  script:
    - yarn --frozen-lockfile
    - yarn run coverage:jest
  artifacts:
    paths:
      - coverage

# coverage_ts:
#   stage: test
#   except:
#     refs:
#       - schedules
#   script:
#     - yarn run coverage:ts
#   artifacts:
#     paths:
#       - coverage-ts

release:
  image: node:13
  stage: release
  only:
    refs:
      - production
      - pre-production
  needs: [install, build_frc_website, build_head, eslint-sast, coverage_jest]
  dependencies:
    - build_frc_website
    - build_head
  before_script:
    - yarn config set cache-folder ~/.yarn
  script:
    - npx -p semantic-release@17.3.6 semantic-release

# Should be set as a scheduled job for cron 0 0 * * 1 (midnight every monday)
dependabot_gitlab:
  image:
    name: docker.io/andrcuns/dependabot-gitlab:latest
    entrypoint: [""]
  rules:
    - if: '$WHICH_SCHEDULE == "dependabot_gitlab"'
  variables:
    GIT_STRATEGY: none
    PACKAGE_MANAGER: npm
    RAILS_ENV: production
    SETTINGS__STANDALONE: "true"
  before_script:
    - cd /home/dependabot
  script:
    - bundle exec rake "dependabot:update[$PROJECT_PATH,$PACKAGE_MANAGER,$DIRECTORY]"
