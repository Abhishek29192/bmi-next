image: node:10

stages:
  - install
  - build
  - check
  - release
  # - deploy

install:
  stage: install
  script:
    - yarn install
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    untracked: true
  artifacts:
    untracked: true
    expire_in: 30 mins

build:
  stage: build
  script:
    - yarn run build:head
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - applications/head/node_modules/

build_frc_website:
  stage: build
  script:
    - yarn run build:frc-website
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - applications/frc-website/node_modules/
      - applications/frc-website/.cache/
      - applications/frc-website/public/
  only:
    changes:
      - applications/frc-website/**/*

coverage_jest:
  stage: check
  script:
    - yarn && yarn run coverage:jest
  dependencies:
    - install
  artifacts:
    paths:
      - coverage

coverage_ts:
  stage: check
  script:
    - yarn run coverage:ts
  dependencies:
    - install
  artifacts:
    paths:
      - coverage-ts

release:
  image: node:13
  stage: release
  dependencies:
    - install
    - build
    - build_frc_website
    - coverage_jest
    - coverage_ts
  only:
    refs:
      - production
      - pre-production
  script:
    - npx semantic-release
