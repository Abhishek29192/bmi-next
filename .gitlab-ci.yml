image: node:14.17.0

stages:
  - install
  - audit
  - static analysis
  - test
  - build
  - release
  - migration
  - package
  - deploy
  - deploy_gateway
  - terraform_plan
  - terraform_execute
  - dynamic security
  - lighthouse scan

workflow:
  rules:
    - if: "$CI_MERGE_REQUEST_LABELS =~ /.*Disable Builds.*/"
      when: never
    - when: always

include:
  - local: "/.gitlab/dependabot.gitlab-ci.yml"
  - local: "/.gitlab/static-analysis.gitlab-ci.yml"
  - local: "/.gitlab/test.gitlab-ci.yml"
  - local: "/applications/frc-website/.gitlab-ci.yml"
  - local: "/applications/dxb/.gitlab-ci.yml"
  - local: "/applications/intouch/.gitlab-ci.yml"
  - local: "/applications/redirects-website/.gitlab-ci.yml"
  - local: "/components/.gitlab-ci.yml"
  - local: "/functions/.gitlab-ci.yml"
  - local: "/libraries/.gitlab-ci.yml"

default:
  cache:
    key:
      files:
        - yarn.lock
    policy: pull
    untracked: false
    paths:
      - "**/node_modules"
      - ".yarn_cache"

variables:
  ARTIFACT_COMPRESSION_LEVEL: fastest
  CACHE_COMPRESSION_LEVEL: fastest
  FF_USE_FASTZIP: "false"
  NODE_OPTIONS: --max-old-space-size=2560
  POSTGRES_DB: custom_db
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: custom_pass
  POSTGRES_HOST_AUTH_METHOD: trust
  TRANSFER_METER_FREQUENCY: 5s

install:
  stage: install
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'merge_request_event' || ($CI_PIPELINE_SOURCE == 'push' && $CI_COMMIT_BRANCH == 'master') || $CI_COMMIT_TAG"
  before_script:
    - yarn config set cache-folder ${PWD}/.yarn_cache
  script:
    - yarn install --frozen-lockfile --check-files
  cache:
    key:
      files:
        - yarn.lock
    untracked: false
    paths:
      - "**/node_modules"
      - ".yarn_cache"
    policy: pull-push

#  https://github.com/pivotal/LicenseFinder
# Remove report arg when we want this job to fail
# Remove installing node 12 when https://github.com/pivotal/LicenseFinder/issues/812 is resolved
license_finder:
  stage: audit
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'merge_request_event' || ($CI_PIPELINE_SOURCE == 'push' && $CI_COMMIT_BRANCH == 'master')"
  needs: []
  image: licensefinder/license_finder:latest
  cache: {}
  before_script:
    - source ~/.bash_profile
    - yarn config set cache-folder ${PWD}/.yarn_cache
  script:
    - license_finder action_items --format html > license_finder_output.html
  artifacts:
    paths:
      - license_finder_output.html
    when: always

release:
  image: node:13
  stage: release
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'push' && ($CI_COMMIT_BRANCH == 'pre-production' || $CI_COMMIT_BRANCH == 'production')"
  before_script:
    - yarn config set cache-folder ${PWD}/.yarn_cache
  script:
    - npx -p semantic-release@17.3.6 semantic-release
