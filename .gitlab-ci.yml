include:
  - project: "$CI_PROJECT_NAMESPACE/gitlab-templates"
    file: "general.gitlab-ci.yml"
  - project: "$CI_PROJECT_NAMESPACE/gitlab-templates"
    file: "images.gitlab-ci.yml"
  - project: "$CI_PROJECT_NAMESPACE/gitlab-templates"
    file: "build.gitlab-ci.yml"
  - project: "$CI_PROJECT_NAMESPACE/gitlab-templates"
    file: "dependabot.gitlab-ci.yml"
  - project: "$CI_PROJECT_NAMESPACE/gitlab-templates"
    file: "functions.gitlab-ci.yml"
  - project: "$CI_PROJECT_NAMESPACE/gitlab-templates"
    file: "static-analysis.gitlab-ci.yml"
  - project: "$CI_PROJECT_NAMESPACE/gitlab-templates"
    file: "test.gitlab-ci.yml"
  - local: "/applications/frc-website/.gitlab-ci.yml"
  - local: "/applications/dxb/.gitlab-ci.yml"
  - local: "/applications/intouch/.gitlab-ci.yml"
  - local: "/applications/redirects-website/.gitlab-ci.yml"
  - local: "/applications/redirects-website-fr-siplast/.gitlab-ci.yml"
  - local: "/applications/redirects-website-fr-monier/.gitlab-ci.yml"
  - local: "/components/.gitlab-ci.yml"
  - local: "/functions/.gitlab-ci.yml"

default:
  cache:
    key:
      files:
        - modules-sha
    policy: pull
    untracked: false
    paths:
      - "**/node_modules"
      - ".yarn_cache"

variables:
  ARTIFACT_COMPRESSION_LEVEL: fastest
  CACHE_COMPRESSION_LEVEL: fastest
  FF_USE_FASTZIP: "false"
  NODE_OPTIONS: --max-old-space-size=2560
  POSTGRES_DB: custom_db
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: custom_pass
  POSTGRES_HOST_AUTH_METHOD: trust
  # There are a coupld of .java files under node_modules which sometimes triggers spotbugs checks
  SAST_EXCLUDED_ANALYZERS: spotbugs semgrep flawfinder
  TRANSFER_METER_FREQUENCY: 5s

image: !reference [.node-full-image, image]

release:
  stage: release
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'push' && ($CI_COMMIT_BRANCH == 'pre-production' || $CI_COMMIT_BRANCH == 'production')"
  before_script:
    - yarn config set cache-folder ${PWD}/.yarn_cache
  script:
    - yarn run semantic-release
