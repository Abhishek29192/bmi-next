image: node:12

include:
  - template: Code-Quality.gitlab-ci.yml
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  - local: "/applications/frc-website/.gitlab-ci.yml"
  - local: "/applications/head/.gitlab-ci.yml"
  - local: "/applications/intouch/frontend/.gitlab-ci.yml"
  - local: "/applications/intouch/api/.gitlab-ci.yml"
  - local: "/applications/intouch/functions/gcp-handle-message/.gitlab-ci.yml"
  - local: "/applications/intouch/terraform/.gitlab-ci.yml"
  - local: "/components/.gitlab-ci.yml"
  - local: "/functions/es-pim-products-ingest/.gitlab-ci.yml"
  - local: "/functions/gcp-apsis-integration/.gitlab-ci.yml"
  - local: "/functions/gcp-download-zip/.gitlab-ci.yml"
  - local: "/functions/gcp-functions-deployer/.gitlab-ci.yml"
  - local: "/functions/gcp-firestore-writer/.gitlab-ci.yml"
  - local: "/functions/gcp-form-submit/.gitlab-ci.yml"
  - local: "/functions/gcp-pim-full-fetch/.gitlab-ci.yml"
  - local: "/functions/gcp-pim-message-handler/.gitlab-ci.yml"
  - local: "/functions/gcp-upload-file/.gitlab-ci.yml"

.sast-analyzer:
  allow_failure: false

code_quality:
  stage: test
  needs: [install]
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'merge_request_event' || ($CI_PIPELINE_SOURCE == 'push' && $CI_COMMIT_BRANCH == 'master')"

sast:
  stage: test

eslint-sast:
  needs: [install]
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'merge_request_event' || ($CI_PIPELINE_SOURCE == 'push' && $CI_COMMIT_BRANCH == 'master')"

nodejs-scan-sast:
  needs: [install]
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'merge_request_event' || ($CI_PIPELINE_SOURCE == 'push' && $CI_COMMIT_BRANCH == 'master')"

# There is a secret_detection_default_branch job for master
secret_detection:
  needs: []
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'merge_request_event'"

cache:
  key:
    files:
      - yarn.lock
  policy: pull
  untracked: false
  paths:
    - "**/node_modules"
    - ".yarn_cache"

stages:
  - install
  - audit
  - test
  - build
  - release
  - package
  - deploy
  - dynamic_security
  - lighthouse_scan

install:
  stage: install
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'merge_request_event' || ($CI_PIPELINE_SOURCE == 'push' && ($CI_COMMIT_BRANCH == 'master' || $CI_COMMIT_BRANCH == 'intouch/dev-environment')) || $CI_COMMIT_TAG"
  before_script:
    - yarn config set cache-folder ${PWD}/.yarn_cache
  script:
    - yarn install --frozen-lockfile
  cache:
    key:
      files:
        - yarn.lock
    untracked: false
    paths:
      - "**/node_modules"
      - ".yarn_cache"
    policy: pull-push

#  https://github.com/pivotal/LicenseFinder
# Remove report arg when we want this job to fail
# Remove installing node 12 when https://github.com/pivotal/LicenseFinder/issues/812 is resolved
license_finder:
  stage: audit
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'merge_request_event' || ($CI_PIPELINE_SOURCE == 'push' && $CI_COMMIT_BRANCH == 'master')"
  needs: []
  image: licensefinder/license_finder:latest
  before_script:
    - source ~/.bash_profile
    - yarn config set cache-folder ${PWD}/.yarn_cache
  script:
    - license_finder action_items --format html > license_finder_output.html
  artifacts:
    paths:
      - license_finder_output.html
    when: always

eslint:
  stage: test
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'merge_request_event' || ($CI_PIPELINE_SOURCE == 'push' && $CI_COMMIT_BRANCH == 'master')"
  needs: [install]
  before_script:
    - yarn config set cache-folder ${PWD}/.yarn_cache
  script:
    - yarn eslint "**/*.{js,ts,tsx}"

release:
  image: node:13
  stage: release
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'push' && ($CI_COMMIT_BRANCH == 'pre-production' || $CI_COMMIT_BRANCH == 'production')"
  before_script:
    - yarn config set cache-folder ${PWD}/.yarn_cache
  script:
    - npx -p semantic-release@17.3.6 semantic-release

# Should be set as a scheduled job for cron 0 0 * * 1 (midnight every monday)
dependabot_gitlab:
  image:
    name: docker.io/andrcuns/dependabot-gitlab:latest
    entrypoint: [""]
  rules:
    - if: '$WHICH_SCHEDULE == "dependabot_gitlab"'
  variables:
    GIT_STRATEGY: none
    PACKAGE_MANAGER: npm
    RAILS_ENV: production
    SETTINGS__STANDALONE: "true"
  before_script:
    - cd /home/dependabot
  script:
    - bundle exec rake "dependabot:update[$PROJECT_PATH,$PACKAGE_MANAGER,$DIRECTORY]"
